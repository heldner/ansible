---
- name: Install isync
  ansible.builtin.package:
    name: isync
    state: present
  become: true
  tags: isync

- name: Create mail dir
  ansible.builtin.file:
    state: directory
    path: '{{ ansible_user_dir}}/Private/Mail'
  tags: isync

- name: Create local inbox
  ansible.builtin.file:
    state: directory
    path: '{{ ansible_user_dir}}/Private/Mail/{{ item.name }}'
  loop: '{{ mbsync_mboxes }}'
  tags: isync

- name: Install mbsync config
  ansible.builtin.template:
    src: mbsyncrc.j2
    dest: '{{ ansible_user_dir}}/Private/Mail/.mbsyncrc'
    owner: '{{ ansible_user_id }}'
    mode: "0600"
  tags: isync

- name: Create links
  ansible.builtin.file:
    state: link
    src: '{{ item.src }}'
    path: '{{ item.path }}'
  loop:
    - src: '{{ ansible_user_dir }}/Private/Mail/.mbsyncrc'
      path: '{{ ansible_user_dir }}/.mbsyncrc'
  tags: isync

- name: Copy update-mail script
  ansible.builtin.file:
    state: absent
    dest: '{{ ansible_user_dir }}/.local/bin/update-mail'
  tags: isync

- name: Add cron update mail
  ansible.builtin.cron:
    state: absent
    name: update mail
    job: '{{ ansible_user_dir }}/.local/bin/update-mail'
    minute: '*/15'
  tags: isync

- name: Fill mailcap
  ansible.builtin.copy:
    dest: '{{ ansible_user_dir }}/Private/Mail/.mailcap'
    content: >
      text/html; w3m -I %{charset} -T text/html -graph -F -no-cookie
      -o confirm_qq=FALSE -o use_wide=TRUE -o display_link=TRUE
      -o color=TRUE %s; copiousoutput;
  tags: isync

- name: Fill mailcap
  ansible.builtin.copy:
    src: watch_mail_dir
    dest: '{{ ansible_user_dir }}/.local/bin/watch_mail_dir'
  tags: isync
