#!/bin/sh

USER={{ ansible_user_id }}
USER_ID=$(id -u $USER)
export HOME=/home/$USER
MBSYNC=/usr/bin/mbsync
TIMEOUT='45s'
MAIL_COUNTER="$HOME/.new_mail_counter"

run_mbsync() {
    if [ -d "/run/user/$USER_ID" ]; then
        timeout $TIMEOUT "$MBSYNC" -a > /dev/null 2>&1
    fi
}

update_counter() {
    find ~/Private/Mail/ -type f -regex '.*inbox\/new.*' \
        | wc -l > "$MAIL_COUNTER"
}

run_mbsync
update_counter

exit 0

